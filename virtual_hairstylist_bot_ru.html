<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Виртуальный парикмахер</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Темно-серый фон */
            color: #f3f4f6; /* Светлый текст */
        }
        .card {
            background-color: #1f2937; /* Карточка чуть светлее фона */
            border: 1px solid #374151; /* Граница карточки */
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #4f46e5; /* Фиолетовый */
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-primary:disabled {
            background-color: #374151;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #374151;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .file-input-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 10rem;
            border: 2px dashed #4b5563;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .file-input-label:hover {
            border-color: #4f46e5;
        }
        .loader {
            border: 4px solid #4b5563;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #modal {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        /* Стили для анимации */
        #animationContainer {
            position: relative;
            width: 100%;
            padding-top: 100%; /* Соотношение сторон 1:1 */
            overflow: hidden;
            border-radius: 0.75rem;
        }
        #animationContainer img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 1s ease-in-out;
        }
        #animationContainer img.animated {
            animation: crossfade 4s infinite ease-in-out;
        }
        @keyframes crossfade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-white">Виртуальный Стилист AI</h1>
            <p class="mt-2 text-lg text-gray-400">Подберите новую прическу с помощью нейросети</p>
        </header>

        <main class="space-y-6">
            <!-- Шаг 1: Загрузка фото клиента -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-white">Шаг 1: Загрузите ваше фото</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div>
                        <input type="file" id="clientImageInput" class="hidden" accept="image/*">
                        <label for="clientImageInput" class="file-input-label" id="clientImageLabel">
                            <svg class="w-12 h-12 text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="text-gray-400 font-medium">Нажмите, чтобы загрузить</span>
                            <span class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP</span>
                        </label>
                    </div>
                    <div id="clientPreviewContainer" class="hidden text-center">
                        <p class="text-sm text-gray-400 mb-2">Ваше фото:</p>
                        <img id="clientPreview" class="rounded-lg w-full max-w-xs mx-auto shadow-lg cursor-pointer" alt="Превью клиента">
                        <button id="suggestHairstyleButton" class="btn btn-secondary mt-4 w-full max-w-xs">✨ Подобрать прическу по фото</button>
                    </div>
                </div>
            </div>

            <!-- Шаг 2: Выбор прически -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-white">Шаг 2: Опишите или покажите желаемую прическу</h2>
                <div class="space-y-4">
                    <div>
                        <label for="hairstyleDescription" class="block text-sm font-medium text-gray-300 mb-1">Пожелания (например, "короткая стрижка пикси платиновый блонд"):</label>
                        <textarea id="hairstyleDescription" rows="4" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Опишите здесь или позвольте AI помочь вам..."></textarea>
                    </div>
                    <div class="text-center text-gray-500">или</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div>
                            <input type="file" id="hairstyleImageInput" class="hidden" accept="image/*">
                            <label for="hairstyleImageInput" class="file-input-label" id="hairstyleImageLabel">
                                <svg class="w-12 h-12 text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span class="text-gray-400 font-medium">Загрузить фото прически</span>
                            </label>
                        </div>
                        <div id="hairstylePreviewContainer" class="hidden text-center">
                             <p class="text-sm text-gray-400 mb-2">Пример прически:</p>
                             <img id="hairstylePreview" class="rounded-lg w-full max-w-xs mx-auto shadow-lg cursor-pointer" alt="Превью прически">
                             <button id="describeHairstyleButton" class="btn btn-secondary mt-4 w-full max-w-xs">✨ Описать прическу с фото</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Шаг 3: Генерация -->
            <div class="text-center">
                <button id="generateButton" class="btn btn-primary text-lg" disabled>
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    Создать превью
                </button>
            </div>
            
            <!-- Результат -->
            <div id="resultSection" class="card hidden">
                <h2 class="text-xl font-semibold mb-4 text-white">Результат</h2>
                 <div id="loadingIndicator" class="flex flex-col items-center justify-center p-8 hidden">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-400">Магия в процессе... Это может занять до минуты.</p>
                </div>
                <div id="resultContent" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="text-center">
                            <h3 class="font-semibold mb-2 text-gray-300">Оригинал</h3>
                            <img id="originalResultImage" class="rounded-lg w-full shadow-lg cursor-pointer" alt="Оригинал">
                        </div>
                        <div class="text-center">
                            <h3 class="font-semibold mb-2 text-gray-300">Новый образ (превью)</h3>
                            <img id="generatedResultImage" class="rounded-lg w-full shadow-lg cursor-pointer" alt="Результат">
                        </div>
                    </div>
                     <div class="mt-6 text-center flex flex-wrap justify-center gap-4">
                        <button id="improveQualityButton" class="btn btn-primary">Улучшить качество</button>
                        <button id="animateButton" class="btn btn-secondary">Создать анимацию</button>
                        <button id="careTipsButton" class="btn btn-secondary">✨ Получить советы по уходу</button>
                        <button id="startOverButton" class="btn btn-secondary">Начать заново</button>
                    </div>
                     <div id="careTipsResult" class="hidden mt-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                        <h4 class="font-semibold mb-2 text-gray-300 text-center">Советы по уходу</h4>
                        <div id="careTipsLoader" class="flex justify-center hidden"><div class="loader"></div></div>
                        <p id="careTipsText" class="text-gray-400 whitespace-pre-wrap"></p>
                    </div>
                </div>
                 <div id="animationResult" class="hidden mt-6">
                     <h3 class="font-semibold mb-2 text-gray-300 text-center">Анимация до/после</h3>
                     <div id="animationContainer" class="mx-auto max-w-md cursor-pointer">
                        <img id="animationBase" src="" alt="Оригинал для анимации">
                        <img id="animationOverlay" src="" alt="Результат для анимации">
                     </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Модальное окно для крупного просмотра -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="relative max-w-4xl max-h-full">
            <img id="modalImage" class="object-contain max-w-full max-h-[90vh] rounded-lg" src="" alt="Крупный просмотр">
            <button id="closeModal" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <script>
        // --- DOM Элементы ---
        const clientImageInput = document.getElementById('clientImageInput');
        const clientImageLabel = document.getElementById('clientImageLabel');
        const clientPreviewContainer = document.getElementById('clientPreviewContainer');
        const clientPreview = document.getElementById('clientPreview');

        const hairstyleImageInput = document.getElementById('hairstyleImageInput');
        const hairstyleImageLabel = document.getElementById('hairstyleImageLabel');
        const hairstylePreviewContainer = document.getElementById('hairstylePreviewContainer');
        const hairstylePreview = document.getElementById('hairstylePreview');
        const hairstyleDescription = document.getElementById('hairstyleDescription');

        const generateButton = document.getElementById('generateButton');
        const resultSection = document.getElementById('resultSection');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultContent = document.getElementById('resultContent');
        const originalResultImage = document.getElementById('originalResultImage');
        const generatedResultImage = document.getElementById('generatedResultImage');

        const improveQualityButton = document.getElementById('improveQualityButton');
        const animateButton = document.getElementById('animateButton');
        const startOverButton = document.getElementById('startOverButton');
        
        const animationResult = document.getElementById('animationResult');
        const animationContainer = document.getElementById('animationContainer');
        const animationBase = document.getElementById('animationBase');
        const animationOverlay = document.getElementById('animationOverlay');

        const modal = document.getElementById('modal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementById('closeModal');

        // Новые DOM элементы для LLM фич
        const suggestHairstyleButton = document.getElementById('suggestHairstyleButton');
        const describeHairstyleButton = document.getElementById('describeHairstyleButton');
        const careTipsButton = document.getElementById('careTipsButton');
        const careTipsResult = document.getElementById('careTipsResult');
        const careTipsLoader = document.getElementById('careTipsLoader');
        const careTipsText = document.getElementById('careTipsText');

        // --- Состояние приложения ---
        let clientImageBase64 = null;
        let hairstyleImageBase64 = null;

        // --- Обработчики событий ---

        clientImageInput.addEventListener('change', (e) => handleFileUpload(e, (dataUrl) => {
            clientImageBase64 = dataUrl.split(',')[1];
            clientPreview.src = dataUrl;
            clientPreviewContainer.classList.remove('hidden');
            clientImageLabel.classList.add('hidden');
            checkGenerateButtonState();
        }));

        hairstyleImageInput.addEventListener('change', (e) => handleFileUpload(e, (dataUrl) => {
            hairstyleImageBase64 = dataUrl.split(',')[1];
            hairstylePreview.src = dataUrl;
            hairstylePreviewContainer.classList.remove('hidden');
            hairstyleImageLabel.classList.add('hidden');
        }));

        function checkGenerateButtonState() {
            generateButton.disabled = !clientImageBase64;
        }

        generateButton.addEventListener('click', () => generateImage("preview"));
        improveQualityButton.addEventListener('click', () => generateImage("high_quality"));

        startOverButton.addEventListener('click', () => {
            clientImageBase64 = null;
            hairstyleImageBase64 = null;
            clientImageInput.value = '';
            hairstyleImageInput.value = '';
            hairstyleDescription.value = '';

            clientPreviewContainer.classList.add('hidden');
            clientImageLabel.classList.remove('hidden');
            hairstylePreviewContainer.classList.add('hidden');
            hairstyleImageLabel.classList.remove('hidden');
            resultSection.classList.add('hidden');
            resultContent.classList.add('hidden');
            animationResult.classList.add('hidden');
            careTipsResult.classList.add('hidden');
            generateButton.disabled = true;
        });
        
        animateButton.addEventListener('click', () => {
            animationBase.src = originalResultImage.src;
            animationOverlay.src = generatedResultImage.src;
            animationResult.classList.remove('hidden');
            animationOverlay.classList.add('animated');
            animationResult.scrollIntoView({ behavior: 'smooth' });
        });

        [clientPreview, hairstylePreview, originalResultImage, generatedResultImage, animationContainer].forEach(el => {
            el.addEventListener('click', (e) => {
                let src = e.currentTarget.id === 'animationContainer' ? generatedResultImage.src : e.currentTarget.src;
                if (src) showModal(src);
            });
        });

        closeModal.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.add('hidden');
        });

        // --- Новые обработчики для LLM фич ---
        
        suggestHairstyleButton.addEventListener('click', async () => {
            const originalButtonText = suggestHairstyleButton.innerHTML;
            suggestHairstyleButton.innerHTML = 'Думаю...';
            suggestHairstyleButton.disabled = true;
            try {
                const prompt = "Проанализируй фото человека. Кратко опиши его форму лица. Предложи 3-4 варианта стрижек, которые ему подойдут. Опиши каждую стрижку в одном-двух предложениях. Ответ дай на русском языке.";
                const resultText = await generateTextFromApi(prompt, clientImageBase64);
                hairstyleDescription.value = resultText;
            } catch (error) {
                alert(`Ошибка: ${error.message}`);
            } finally {
                suggestHairstyleButton.innerHTML = originalButtonText;
                suggestHairstyleButton.disabled = false;
            }
        });

        describeHairstyleButton.addEventListener('click', async () => {
            const originalButtonText = describeHairstyleButton.innerHTML;
            describeHairstyleButton.innerHTML = 'Анализирую...';
            describeHairstyleButton.disabled = true;
            try {
                const prompt = "Ты - профессиональный парикмахер. Подробно опиши прическу на этом фото. Укажи тип стрижки, технику окрашивания, цвет, укладку и возможную сложность исполнения. Ответ дай на русском языке.";
                const resultText = await generateTextFromApi(prompt, hairstyleImageBase64);
                hairstyleDescription.value = resultText;
            } catch (error) {
                alert(`Ошибка: ${error.message}`);
            } finally {
                describeHairstyleButton.innerHTML = originalButtonText;
                describeHairstyleButton.disabled = false;
            }
        });
        
        careTipsButton.addEventListener('click', async () => {
            careTipsResult.classList.remove('hidden');
            careTipsLoader.classList.remove('hidden');
            careTipsText.classList.add('hidden');
            careTipsResult.scrollIntoView({ behavior: 'smooth' });
            try {
                const prompt = `Дай профессиональные советы по уходу за волосами для следующей прически: "${hairstyleDescription.value || 'современная стильная стрижка'}". Расскажи, как часто мыть голову, какие средства использовать для укладки и как поддерживать цвет и форму. Ответ дай на русском языке в виде списка.`;
                const resultText = await generateTextFromApi(prompt);
                careTipsText.innerText = resultText;
            } catch (error) {
                careTipsText.innerText = `Произошла ошибка: ${error.message}`;
            } finally {
                careTipsLoader.classList.add('hidden');
                careTipsText.classList.remove('hidden');
            }
        });

        // --- Функции ---

        function handleFileUpload(event, callback) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => callback(e.target.result);
                reader.readAsDataURL(file);
            }
        }
        
        function showModal(src) {
            modalImage.src = src;
            modal.classList.remove('hidden');
        }

        // --- Новая функция для вызова языковой модели Gemini ---
        async function generateTextFromApi(prompt, imageBase64 = null) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const parts = [{ text: prompt }];
            if (imageBase64) {
                parts.push({ inlineData: { mimeType: "image/jpeg", data: imageBase64 } });
            }

            const payload = {
                contents: [{ role: "user", parts: parts }],
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.json();
                console.error('API Error:', error);
                throw new Error(`Ошибка сети: ${response.statusText}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!text) {
                throw new Error('Не удалось получить ответ от AI. Попробуйте снова.');
            }
            return text;
        }

        // Основная функция генерации изображения
        async function generateImage(quality) {
            if (!clientImageBase64) {
                alert('Пожалуйста, сначала загрузите ваше фото.');
                return;
            }

            resultSection.classList.remove('hidden');
            resultContent.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            animationResult.classList.add('hidden');
            careTipsResult.classList.add('hidden'); // Скрываем советы при новой генерации
            generateButton.disabled = true;
            
            loadingIndicator.querySelector('p').textContent = quality === 'high_quality' 
                ? 'Улучшаем качество... Это может занять больше времени.'
                : 'Магия в процессе... Это может занять до минуты.';
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
            
            const userTextPrompt = hairstyleDescription.value || "a stylish modern haircut";
            const prompt = `INSTRUCTION: You are an expert virtual hairstylist. Your task is to edit the provided user image.
- **PRIMARY GOAL**: Replace ONLY the hair in the user's image with a new hairstyle based on the user's text description: "${userTextPrompt}".
- **ABSOLUTE RULE**: You MUST NOT change the person's face, facial features, eyes, nose, mouth, skin texture, or the background. The identity of the person must be perfectly preserved. ONLY the hair should be altered.
- **REFERENCE**: If a second image is provided, use it as a style reference for the new hair.
- **QUALITY**: Generate a ${quality === 'high_quality' ? 'high-resolution, detailed' : 'quick preview quality'} image.`;

            const parts = [
                { text: prompt },
                { inlineData: { mimeType: "image/jpeg", data: clientImageBase64 } }
            ];

            if (hairstyleImageBase64) {
                parts.push({ inlineData: { mimeType: "image/jpeg", data: hairstyleImageBase64 } });
            }

            const payload = {
                contents: [{ parts }],
                generationConfig: { responseModalities: ['TEXT', 'IMAGE'] },
            };

            try {
                let response;
                let retries = 3;
                let delay = 1000;
                for (let i = 0; i < retries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        break;
                    }
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('API Error:', error);
                    throw new Error(`Ошибка сети: ${response.statusText}`);
                }

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    throw new Error('Не удалось получить изображение от AI. Возможно, запрос был заблокирован из-за правил безопасности. Попробуйте другое фото.');
                }
                
                const imageUrl = `data:image/png;base64,${base64Data}`;
                generatedResultImage.src = imageUrl;
                originalResultImage.src = `data:image/jpeg;base64,${clientImageBase64}`;
                
                loadingIndicator.classList.add('hidden');
                resultContent.classList.remove('hidden');

            } catch (error) {
                console.error('Ошибка при генерации:', error);
                loadingIndicator.classList.add('hidden');
                resultContent.classList.remove('hidden');
                resultContent.innerHTML = `<p class="text-center text-red-400">Произошла ошибка: ${error.message}</p> 
                <div class="text-center mt-4"><button onclick="location.reload()" class="btn btn-secondary">Попробовать снова</button></div>`;
            } finally {
                generateButton.disabled = false;
            }
        }
    </script>
</body>
</html>