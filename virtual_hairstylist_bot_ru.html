<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Виртуальный Стилист AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .glass-effect { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .animated-gradient { background-size: 200% 200%; animation: gradient-animation 10s ease infinite; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .image-container img { object-fit: contain; } 
        .image-container .placeholder { aspect-ratio: 1 / 1; object-fit: cover; } 
        .modal-image-animation { animation: zoomIn 0.3s ease-out; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        [x-cloak] { display: none !important; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('imageGenerator', () => ({
                clientPhoto: { file: null, preview: null },
                stylePhoto: { file: null, preview: null },
                generatedImage: { preview: null },
                prompt: '',
                loading: false,
                statusText: 'Магия начинается...',
                modal: { visible: false, title: '', content: '', type: 'text' },
                animation: { timer: null, isOriginal: true },
                
                generationCount: 0,
                maxGenerations: 10,
                isPro: false,
                promoCode: '',
                correctPromoCode: 'STILIST',
                testPromoCode: 'TEST30',

                init() {
                    const savedCount = localStorage.getItem('generationCount_v2');
                    this.generationCount = savedCount ? parseInt(savedCount, 10) : 0;
                    
                    const proStatus = localStorage.getItem('isPro_v2');
                    this.isPro = proStatus === 'true';

                    const maxGen = localStorage.getItem('maxGenerations_v2');
                    this.maxGenerations = maxGen ? parseInt(maxGen, 10) : 10;
                },

                applyPromoCode() {
                    const code = this.promoCode.trim().toUpperCase();
                    if (code === this.correctPromoCode.toUpperCase()) {
                        this.isPro = true;
                        localStorage.setItem('isPro_v2', 'true');
                        this.openModal('Промокод для PRO-доступа успешно применен! Все ограничения сняты.', 'Успех!', 'text');
                    } else if (code === this.testPromoCode.toUpperCase()) {
                        this.maxGenerations += 30;
                        localStorage.setItem('maxGenerations_v2', this.maxGenerations);
                        this.openModal('Вам добавлено 30 генераций!', 'Успех!', 'text');
                    } else {
                        this.openModal('Неверный промокод.', 'Ошибка', 'text');
                    }
                    this.promoCode = '';
                },
                
                handleFileSelect(event, photoType) { const file = event.target.files[0]; if (file) this.processFile(file, photoType); },
                handleFileDrop(event, photoType) { const file = event.dataTransfer.files[0]; if (file) this.processFile(file, photoType); },
                processFile(file, photoType) {
                    if (!file.type.startsWith('image/')) { this.showErrorModal('Пожалуйста, выберите файл изображения.'); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => { this[photoType].preview = e.target.result; };
                    reader.readAsDataURL(file);
                    this.toBase64(file).then(base64 => { this[photoType].file = base64; });
                },
                toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); },
                openModal(content, title = 'Просмотр', type = 'image') { this.modal = { visible: true, title, content, type }; if (type === 'animation') this.startAnimation(); },
                closeModal() { this.modal.visible = false; clearInterval(this.animation.timer); },
                showErrorModal(message) { this.loading = false; this.openModal(message, 'Ошибка', 'text'); },
                resetAll() { this.clientPhoto = { file: null, preview: null }; this.stylePhoto = { file: null, preview: null }; this.generatedImage = { preview: null }; this.prompt = ''; this.$refs.clientPhotoInput.value = ''; this.$refs.stylePhotoInput.value = ''; },
                createAnimation() { this.openModal('', 'Анимация До/После', 'animation'); },
                startAnimation() { this.animation.isOriginal = true; this.animation.timer = setInterval(() => { this.animation.isOriginal = !this.animation.isOriginal; }, 1500); },

                async callProxy(targetApi, payload) {
                    this.loading = true;
                    const proxyUrl = 'https://virtual-hairstylist-production.up.railway.app'; 
                    try {
                        const response = await fetch(`${proxyUrl}/api/proxy`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ target_api: targetApi, payload: payload })
                        });
                        if (!response.ok) {
                            const errorText = await response.text();
                            try { const errorBody = JSON.parse(errorText); throw new Error(`HTTP error! status: ${response.status}, message: ${errorBody.error?.message || errorText}`); } catch (e) { throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`); }
                        }
                        return await response.json();
                    } catch (error) {
                        console.error('Proxy Error:', error);
                        this.showErrorModal('Произошла ошибка при обращении к серверу. Детали: ' + error.message);
                        return null;
                    } finally {
                        this.loading = false;
                    }
                },

                async generateImage(isUpscale) {
                    if (!this.isPro && this.generationCount >= this.maxGenerations) {
                        this.showErrorModal(`Вы исчерпали лимит бесплатных генераций (${this.maxGenerations}). Введите промокод, чтобы продолжить.`);
                        return;
                    }
                    this.statusText = isUpscale ? 'Улучшаем качество...' : 'Создаем новый образ...';
                    let userPrompt = this.prompt || "новая прическа";
                    if (isUpscale) { userPrompt = "улучшить качество, высокая детализация, 4k. " + userPrompt; }
                    const systemPrompt = "ТЫ — ПРОФЕССИОНАЛЬНЫЙ ФОТОРЕАЛИСТИЧНЫЙ AI-ПАРИКМАХЕР. ТВОЯ ГЛАВНАЯ ЗАДАЧА: ПОЛНОСТЬЮ ЗАМЕНИТЬ старую прическу на новую, а не накладывать поверх. ИНСТРУКЦИИ: 1. **УДАЛИ** все видимые части старых волос. 2. Создай новую прическу согласно запросу клиента. 3. **АБСОЛЮТНОЕ ТРЕБОВАНИЕ:** Лицо, черты лица, выражение лица, кожа, одежда и фон ДОЛЖНЫ ОСТАВАТЬСЯ ПОЛНОСТЬЮ НЕИЗМЕННЫМИ. Изменяются **ТОЛЬКО ВОЛОСЫ**. 4. Результат должен быть фотореалистичным и соответствовать стилю оригинальной фотографии.";
                    const payload = { contents: [{ parts: [ { text: systemPrompt }, { text: `ЗАПРОС КЛИЕНТА: ${userPrompt}` }, { inlineData: { mimeType: "image/jpeg", data: this.clientPhoto.file } } ] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }, };
                    if (this.stylePhoto.file) { payload.contents[0].parts.push({ text: "ИСПОЛЬЗУЙ ЭТО ФОТО КАК ОБРАЗЕЦ СТИЛЯ ПРИЧЕСКИ:" }); payload.contents[0].parts.push({ inlineData: { mimeType: "image/jpeg", data: this.stylePhoto.file } }); }
                    const result = await this.callProxy('image', payload);
                    if (result) {
                        const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        if (base64Data) { 
                            this.generatedImage.preview = `data:image/png;base64,${base64Data}`;
                            if (!isUpscale && !this.isPro) {
                                this.generationCount++;
                                localStorage.setItem('generationCount_v2', this.generationCount);
                            }
                        } 
                        else { const errorMessage = result?.error?.message || 'Ответ от AI не содержит изображения.'; this.showErrorModal(errorMessage); }
                    }
                },
                async callLLM(systemPrompt, userPrompt, imageFile = null) {
                    const payload = { contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                    if(imageFile) { payload.contents[0].parts.push({ inlineData: { mimeType: "image/jpeg", data: imageFile } }); }
                    const result = await this.callProxy('text', payload);
                    if (result) { const text = result?.candidates?.[0]?.content?.parts?.[0]?.text; if (text) { return text; } }
                    this.showErrorModal('Не удалось получить ответ от языковой модели.');
                    return null;
                },
                async getHairstyleSuggestions() {
                    const systemPrompt = "Ты - опытный парикмахер-стилист. Проанализируй фото клиента и кратко, списком (используя *), предложи 3-4 варианта стрижек или причесок, которые подойдут к его типу лица. Говори на русском языке.";
                    const userPrompt = "Посоветуй, какие прически мне подойдут?";
                    const result = await this.callLLM(systemPrompt, userPrompt, this.clientPhoto.file);
                    if (result) { this.openModal(result.replace(/\*/g, '•'), 'Рекомендации по прическам', 'text'); }
                },
                async describeHairstyle() {
                    const systemPrompt = "Ты - профессиональный парикмахер. Опиши прическу на фото. Укажи тип стрижки, длину, цвет, укладку. Будь краток и точен. Говори на русском языке.";
                    const userPrompt = "Опиши эту прическу.";
                    const result = await this.callLLM(systemPrompt, userPrompt, this.stylePhoto.file);
                    if (result) { this.prompt = result; }
                }
            }));
        });
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen antialiased animated-gradient bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900">

<div x-data="imageGenerator" x-init="init()" class="container mx-auto max-w-4xl p-4">
    <header class="text-center my-6"><h1 class="text-4xl md:text-5xl font-bold tracking-tight">Виртуальный Стилист <span class="text-purple-400">AI</span></h1><p class="text-gray-300 mt-2 text-lg">Примерьте новый образ за секунды</p></header>

    <div x-show="!isPro" x-cloak class="mb-6 glass-effect rounded-2xl p-4 text-center">
        <p class="mb-2 font-semibold">Осталось бесплатных генераций: <span x-text="Math.max(0, maxGenerations - generationCount)" class="text-purple-400 text-lg"></span> / <span x-text="maxGenerations"></span></p>
        <div class="flex justify-center mt-2"><input type="text" x-model="promoCode" @keyup.enter="applyPromoCode()" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full md:w-1/2 p-2.5" placeholder="Введите промокод"><button @click="applyPromoCode()" class="ml-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Применить</button></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
        <div class="glass-effect rounded-2xl p-6 space-y-6">
            <div>
                <h3 class="text-lg font-semibold mb-3 border-b-2 border-purple-500 pb-2">1. Загрузите ваше фото</h3>
                <div @dragover.prevent @drop.prevent="handleFileDrop($event, 'clientPhoto')" class="image-container relative bg-gray-800 rounded-lg h-64 flex items-center justify-center border-2 border-dashed border-gray-600 hover:border-purple-500 transition-colors cursor-pointer" @click="$refs.clientPhotoInput.click()"><template x-if="!clientPhoto.preview"><div class="text-center text-gray-400 placeholder"><svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><p class="mt-2">Нажмите или перетащите фото</p></div></template><template x-if="clientPhoto.preview"><img :src="clientPhoto.preview" alt="Фото клиента" class="rounded-lg h-full w-full" @click.stop="openModal(clientPhoto.preview)"></template></div>
                <input type="file" x-ref="clientPhotoInput" @change="handleFileSelect($event, 'clientPhoto')" accept="image/*" class="hidden">
                <button x-show="clientPhoto.preview" @click="getHairstyleSuggestions()" :disabled="loading" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center"><svg x-show="!loading" class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.5 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg><span x-text="loading ? 'Анализ...' : '✨ Подобрать прическу по фото'"></span></button>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-3 border-b-2 border-purple-500 pb-2">2. Опишите или покажите прическу</h3>
                <textarea x-model="prompt" rows="3" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition" placeholder="Например: длинные волнистые волосы медного цвета..."></textarea>
                <p class="text-center text-gray-400 my-2">-- ИЛИ --</p>
                <div @dragover.prevent @drop.prevent="handleFileDrop($event, 'stylePhoto')" class="image-container relative bg-gray-800 rounded-lg h-48 flex items-center justify-center border-2 border-dashed border-gray-600 hover:border-purple-500 transition-colors cursor-pointer" @click="$refs.stylePhotoInput.click()"><template x-if="!stylePhoto.preview"><div class="text-center text-gray-400 placeholder"><svg class="w-10 h-10 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7z M7 16v-8m0 8a2 2 0 100-4 2 2 0 000 4z"/></svg><p class="mt-2">Загрузите фото-пример</p></div></template><template x-if="stylePhoto.preview"><img :src="stylePhoto.preview" alt="Фото прически" class="rounded-lg h-full w-full" @click.stop="openModal(stylePhoto.preview)"></template></div>
                <input type="file" x-ref="stylePhotoInput" @change="handleFileSelect($event, 'stylePhoto')" accept="image/*" class="hidden">
                <button x-show="stylePhoto.preview" @click="describeHairstyle()" :disabled="loading" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center"><svg x-show="!loading" class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.375 6.75h17.25M3.375 12h17.25M3.375 17.25h17.25" /></svg><span x-text="loading ? 'Описание...' : '✨ Описать прическу с фото'"></span></button>
            </div>
            <button @click="generateImage(false)" :disabled="loading || !clientPhoto.file || (!prompt && !stylePhoto.file) || (!isPro && generationCount >= maxGenerations)" class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400 text-white font-bold py-3 px-4 rounded-lg text-lg transition transform hover:scale-105"><span x-show="!loading">Сгенерировать образ</span><span x-show="loading">Создание...</span></button>
            <button @click="resetAll()" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">СБРОС</button>
        </div>
        <div class="glass-effect rounded-2xl p-6 space-y-6">
            <h3 class="text-lg font-semibold mb-3 border-b-2 border-purple-500 pb-2">3. Результат</h3>
            <div class="image-container relative bg-gray-800 rounded-lg min-h-[256px] flex items-center justify-center border-2 border-gray-700"><template x-if="!loading && !generatedImage.preview"><div class="text-center text-gray-400"><svg class="w-12 h-12 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.82m5.84-2.56a12.022 12.022 0 01-11.68 0 6 6 0 1111.68 0z" /></svg><p class="mt-2">Здесь появится ваша новая прическа</p></div></template><div x-show="loading" class="flex flex-col items-center justify-center"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div><p class="text-lg text-gray-300" x-text="statusText"></p></div><template x-if="generatedImage.preview"><img :src="generatedImage.preview" alt="Сгенерированное изображение" class="rounded-lg max-h-[50vh] w-auto max-w-full" @click.stop="openModal(generatedImage.preview)"></template></div>
            <div class="grid grid-cols-2 gap-4" x-show="generatedImage.preview">
                <button @click="generateImage(true)" :disabled="loading" class="w-full bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Улучшить качество</button>
                <button @click="createAnimation()" :disabled="loading" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Анимация До/После</button>
            </div>
        </div>
    </div>
    <div x-show="modal.visible" x-cloak class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" @click="closeModal()"><div class="bg-gray-800 rounded-2xl shadow-lg max-w-lg w-full p-6 text-center modal-image-animation" @click.stop><h3 class="text-2xl font-bold mb-4" x-text="modal.title"></h3><div x-show="modal.type === 'image'" class="mb-4"><img :src="modal.content" class="max-w-full max-h-[70vh] rounded-lg mx-auto"></div>
            <!-- ИЗМЕНЕНИЕ ЗДЕСЬ: object-cover заменен на object-contain -->
            <div x-show="modal.type === 'animation'" class="mb-4 relative w-full" style="padding-bottom: 100%;"><img :src="animation.isOriginal ? clientPhoto.preview : generatedImage.preview" class="absolute top-0 left-0 w-full h-full object-contain rounded-lg"></div>
            <div x-show="modal.type === 'text'" class="mb-4 text-left text-gray-300 whitespace-pre-wrap max-h-[60vh] overflow-y-auto" x-html="modal.content"></div><button @click="closeModal()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition">Закрыть</button></div></div>
</div>

</body>
</html>
