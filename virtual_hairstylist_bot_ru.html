<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MISS SLIVKI AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root">
        <div style="min-height: 100vh; background: linear-gradient(135deg, #3a2f26 0%, #4a3f36 20%, #5a4f46 40%, #6a5f56 60%, #7a6f66 80%, #8a7f76 100%); font-family: Inter, sans-serif; color: #f5f0e8; overflow-x: hidden;">
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div style="text-align: center; padding: 40px 24px 32px;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 16px;">
                    <div style="text-align: center;">
                        <h1 style="font-size: 42px; font-weight: 300; margin: 0; color: #ffffff; text-shadow: 0 4px 12px rgba(0,0,0,0.5); letter-spacing: 2px; font-family: 'Inter', sans-serif;">
                            MISS SLIVKI AI
                        </h1>
                        <p style="font-size: 18px; color: #f0e8d8; margin: 8px 0 0 0; font-weight: 400; opacity: 0.9; letter-spacing: 0.5px; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                            –ü—Ä–∏–º–µ—Ä—å—Ç–µ –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ –∑–∞ —Å–µ–∫—É–Ω–¥—ã
                        </p>
                    </div>
                </div>
            </div>

            <!-- –°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
            <div style="margin: 24px; padding: 24px; background: rgba(255, 255, 255, 0.1); border-radius: 20px; backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <span style="font-size: 22px;">üí°</span>
                    <h3 style="font-size: 18px; font-weight: 600; margin: 0; color: #ffffff;">–°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</h3>
                </div>
                <ul style="margin: 0; padding-left: 24px; color: #f0e8d8; line-height: 1.6; font-size: 15px;">
                    <li style="margin-bottom: 12px;">
                        <strong style="color: #ffffff;">–§–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç–∞:</strong> –ó–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–æ—Ç–æ –∞–Ω—Ñ–∞—Å, —Å —Ö–æ—Ä–æ—à–∏–º –æ—Å–≤–µ—â–µ–Ω–∏–µ–º, –≥–¥–µ –≤–æ–ª–æ—Å—ã —á–µ—Ç–∫–æ –≤–∏–¥–Ω—ã –∏ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç—ã —Ä—É–∫–∞–º–∏ –∏–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏.
                    </li>
                    <li style="margin-bottom: 12px;">
                        <strong style="color: #ffffff;">–§–æ—Ç–æ-–ø—Ä–∏–º–µ—Ä:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≥–¥–µ –ø—Ä–∏—á–µ—Å–∫–∞ —Ö–æ—Ä–æ—à–æ –≤–∏–¥–Ω–∞ –Ω–∞ –º–æ–¥–µ–ª–∏, —Å–º–æ—Ç—Ä—è—â–µ–π –ø—Ä—è–º–æ –≤ –∫–∞–º–µ—Ä—É.
                    </li>
                    <li>
                        <strong style="color: #ffffff;">–û–ø–∏—Å–∞–Ω–∏–µ:</strong> –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–¥–æ –ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –Ω–µ—Ç —Ñ–æ—Ç–æ-–ø—Ä–∏–º–µ—Ä–∞! –ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã. –£–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ü–≤–µ—Ç, –¥–ª–∏–Ω—É, –Ω–∞–ª–∏—á–∏–µ —á–µ–ª–∫–∏ –∏ —Ç–∏–ø —É–∫–ª–∞–¥–∫–∏.
                    </li>
                </ul>
            </div>

            <!-- –°—á–µ—Ç—á–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∏ –ø—Ä–æ–º–æ–∫–æ–¥ -->
            <div style="margin: 24px; padding: 20px; background: rgba(255, 255, 255, 0.12); border-radius: 16px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);">
                <p style="text-align: center; font-size: 16px; color: #ffffff; margin: 0 0 16px 0; font-weight: 500;">
                    –û—Å—Ç–∞–ª–æ—Å—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π: <span id="remaining-count">5</span> / <span id="max-count">10</span>
                </p>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <input 
                        type="text" 
                        id="promo-input" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥"
                        style="width: 100%; padding: 12px 16px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: #ffffff; font-size: 15px; backdrop-filter: blur(6px);"
                    />
                    <div style="display: flex; gap: 8px;">
                        <button 
                            id="apply-promo" 
                            style="flex: 1; padding: 12px 16px; background: linear-gradient(45deg, #8a7f76, #9a8f86); color: #ffffff; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: all 0.2s;"
                        >
                            –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                        </button>
                        <button 
                            id="buy-generations" 
                            style="flex: 1; padding: 12px 16px; background: linear-gradient(45deg, #6a5f56, #7a6f66); color: #ffffff; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: all 0.2s;"
                        >
                            –ö—É–ø–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                        </button>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; margin: 24px; max-width: 1400px; margin-left: auto; margin-right: auto;">
                
                <!-- –ë–ª–æ–∫ 1: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ -->
                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 28px; backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
                    <h3 style="font-size: 20px; font-weight: 600; margin: 0 0 20px 0; color: #ffffff;">1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ</h3>
                    
                    <div id="client-photo-uploader" style="border: 2px dashed rgba(255, 255, 255, 0.3); border-radius: 16px; padding: 36px; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(255, 255, 255, 0.05);">
                        <div style="font-size: 56px; margin-bottom: 16px; color: #f0e8d8;">üì∑</div>
                        <p style="margin: 0; color: #f0e8d8; font-weight: 500; font-size: 16px;">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ</p>
                    </div>
                    
                    <div id="client-photo-preview" style="display: none; text-align: center; margin-top: 20px;">
                        <img id="client-preview-img" style="max-width: 100%; height: auto; border-radius: 16px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);" />
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button id="suggest-hairstyles" style="width: 100%; padding: 14px; background: linear-gradient(45deg, #8a7f76, #9a8f86); color: #ffffff; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px; transition: all 0.2s;">
                            üí° –°–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–∏—á–µ—Å–∫–µ
                        </button>
                    </div>
                </div>

                <!-- –ë–ª–æ–∫ 2: –û–ø–∏—à–∏—Ç–µ –∏–ª–∏ –ø–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–µ—Å–∫—É -->
                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 28px; backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
                    <h3 style="font-size: 20px; font-weight: 600; margin: 0 0 20px 0; color: #ffffff;">2. –û–ø–∏—à–∏—Ç–µ –∏–ª–∏ –ø–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–µ—Å–∫—É</h3>
                    
                    <textarea id="prompt-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–ª–∏–Ω–Ω—ã–µ –≤–æ–ª–Ω–∏—Å—Ç—ã–µ –≤–æ–ª–æ—Å—ã –º–µ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞..." rows="4" 
                             style="width: 100%; padding: 16px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; background: rgba(255, 255, 255, 0.1); color: #ffffff; resize: vertical; font-family: Inter, sans-serif; backdrop-filter: blur(6px); font-size: 15px; line-height: 1.5;"></textarea>
                    
                    <div style="text-align: center; margin: 20px 0; color: #d0c0b0; font-weight: 600; font-size: 16px;">-- –ò–õ–ò --</div>
                    
                    <div id="style-photo-uploader" style="border: 2px dashed rgba(255, 255, 255, 0.3); border-radius: 16px; padding: 36px; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(255, 255, 255, 0.05);">
                        <div style="font-size: 56px; margin-bottom: 16px; color: #f0e8d8;">üé®</div>
                        <p style="margin: 0; color: #f0e8d8; font-weight: 500; font-size: 16px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ-–ø—Ä–∏–º–µ—Ä</p>
                    </div>
                    
                    <div id="style-photo-preview" style="display: none; text-align: center; margin-top: 20px;">
                        <img id="style-preview-img" style="max-width: 100%; height: auto; border-radius: 16px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);" />
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button id="describe-hairstyle" style="width: 100%; padding: 14px; background: linear-gradient(45deg, #8a7f76, #9a8f86); color: #ffffff; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px; transition: all 0.2s;">
                            üìù –û–ø–∏—Å–∞—Ç—å –ø—Ä–∏—á–µ—Å–∫—É —Å —Ñ–æ—Ç–æ
                        </button>
                    </div>
                </div>

                <!-- –ë–ª–æ–∫ 3: –†–µ–∑—É–ª—å—Ç–∞—Ç -->
                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 28px; backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);">
                    <h3 style="font-size: 20px; font-weight: 600; margin: 0 0 20px 0; color: #ffffff;">3. –†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
                    
                    <div id="loading-container" style="display: none; text-align: center; padding: 56px;">
                        <div style="width: 48px; height: 48px; border: 4px solid rgba(255, 255, 255, 0.2); border-top: 4px solid #ffffff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <p id="loading-text" style="margin: 0; color: #f0e8d8; font-weight: 500; font-size: 16px;">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞...</p>
                    </div>
                    
                    <div id="result-placeholder" style="text-align: center; padding: 56px; color: #d0c0b0;">
                        <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.7;">‚ú®</div>
                        <p style="margin: 0; font-weight: 500; font-size: 16px;">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≤–∞—à–∞ –Ω–æ–≤–∞—è –ø—Ä–∏—á–µ—Å–∫–∞</p>
                    </div>
                    
                    <div id="result-container" style="display: none; text-align: center;">
                        <img id="result-image" style="max-width: 100%; height: auto; border-radius: 16px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);" />
                        
                        <!-- –ö–ù–û–ü–ö–ò –ü–û–î–ï–õ–ò–¢–¨–°–Ø -->
                        <div id="share-buttons" style="margin-top: 20px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button id="share-vk" style="flex: 1; min-width: 120px; padding: 12px 16px; background: #0077FF; color: #ffffff; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                                üì± –í–ö–æ–Ω—Ç–∞–∫—Ç–µ
                            </button>
                            <button id="share-telegram" style="flex: 1; min-width: 120px; padding: 12px 16px; background: #0088CC; color: #ffffff; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                                üì¢ Telegram
                            </button>
                            <button id="download-result" style="flex: 1; min-width: 120px; padding: 12px 16px; background: linear-gradient(45deg, #5a4f46, #6a5f56); color: #ffffff; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                                üíæ –°–∫–∞—á–∞—Ç—å
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 12px;">
                        <button id="generate-button" style="flex: 1; padding: 16px; background: linear-gradient(45deg, #6a5f56, #7a6f66); color: #ffffff; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 17px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); transition: all 0.2s;">
                            üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑
                        </button>
                        <button id="reset-all" style="padding: 16px; background: rgba(255, 255, 255, 0.15); color: #ffffff; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                            üîÑ –°–ë–†–û–°
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; backdrop-filter: blur(12px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%; background: linear-gradient(135deg, rgba(90, 79, 70, 0.95), rgba(106, 95, 86, 0.95)); border-radius: 20px; padding: 32px; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modal-title" style="margin: 0; font-size: 20px; font-weight: 600; color: #ffffff;"></h3>
                <button id="close-modal" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #f0e8d8; padding: 8px; border-radius: 8px; transition: all 0.2s;">√ó</button>
            </div>
            <div id="modal-content" style="color: #f0e8d8; line-height: 1.6; font-size: 15px;"></div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: Inter, sans-serif;
        }
        
        * {
            box-sizing: border-box;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(240, 232, 216, 0.6);
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4) !important;
        }
        
        #client-photo-uploader:hover, #style-photo-uploader:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø */
        @media (max-width: 768px) {
            h1 {
                font-size: 32px !important;
            }
            
            #share-buttons {
                flex-direction: column !important;
            }
            
            #share-buttons button {
                min-width: auto !important;
            }
        }
    </style>

    <script>
        const proxyUrl = window.location.origin;
        
        // –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ü–ê–ú–Ø–¢–ò
        try {
            localStorage.clear();
            console.log('–ü–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞');
        } catch (e) {
            console.log('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø–∞–º—è—Ç–∏');
        }
        
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
        const CORRECT_PROMO_CODE = 'STILIST';
        const TEST_PROMO_CODE = 'TEST30';
        
        // –°–£–ü–ï–†-–ü–†–û–ú–ü–¢–´ –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï)
        const GENERATION_SYSTEM_PROMPT = `You are a master AI hairstylist specializing in photorealistic hair transplantation. Your mission is SURGICAL PRECISION hair replacement with ABSOLUTE identity preservation.

MOBILE DEVICE OPTIMIZATION:
- Enhanced facial feature preservation for mobile processing
- Maximum precision in hair-only modifications
- Optimized quality output for mobile screens

ABSOLUTE RULES:
1. FACE IS UNTOUCHABLE: Preserve 100% of original facial features, skin tone, bone structure, expression, eye color
2. HAIR TRANSPLANT MISSION: Remove ALL original hair, install new hairstyle with surgical precision
3. REFERENCE IMAGE AUTHORITY: If provided, copy hairstyle with photographic accuracy
4. SEAMLESS INTEGRATION: Perfect blending at natural hairline

HAIR TRANSFER PROTOCOL:
‚úì LENGTH: Match reference proportions exactly
‚úì CUT TECHNIQUE: Copy layers, angles, precision cuts identically
‚úì COLOR PALETTE: Replicate tones, highlights, gradients perfectly
‚úì TEXTURE PATTERN: Mirror straight/wavy/curly exactly
‚úì STYLING DIRECTION: Copy volume placement and flow precisely
‚úì DETAILS: Reproduce bangs, partings, asymmetry flawlessly

MOBILE QUALITY ASSURANCE:
- Professional salon photograph quality
- Original lighting and shadows maintained
- Photorealistic hair texture and movement
- Natural integration with client's features
- Zero facial feature alteration`;

        const SUGGESTION_SYSTEM_PROMPT = `You are an expert hairstylist. Analyze this face shape and features. Provide 3-4 specific hairstyle recommendations in Russian using bullet points. Be concise and practical.`;

        const DESCRIBE_SYSTEM_PROMPT = `Analyze this hairstyle and provide a brief technical description in Russian. Include only: length, cut type, color, texture. Maximum 2 sentences. No introductions, no explanations, no formatting.`;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let clientPhoto = { file: null, preview: null, base64: null };
        let stylePhoto = { file: null, preview: null, base64: null };
        let generatedImage = { preview: null };
        let loading = false;
        let modal = { visible: false, title: '', content: '', type: 'text' };
        
        // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
        let generationCount = parseInt(localStorage.getItem('generationCount_v2') || '0');
        let maxGenerations = parseInt(localStorage.getItem('maxGenerations_v2') || '10');
        let isPro = localStorage.getItem('isPro_v2') === 'true';
        
        // –£—Ç–∏–ª–∏—Ç—ã
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        };
        
        const showErrorModal = (message) => {
            setLoading(false);
            setModal({ visible: true, title: '–û—à–∏–±–∫–∞', content: message, type: 'text' });
        };
        
        const setLoading = (isLoading) => {
            loading = isLoading;
            const loadingContainer = document.getElementById('loading-container');
            const resultPlaceholder = document.getElementById('result-placeholder');
            const generateButton = document.getElementById('generate-button');
            
            if (isLoading) {
                loadingContainer.style.display = 'block';
                resultPlaceholder.style.display = 'none';
                generateButton.disabled = true;
            } else {
                loadingContainer.style.display = 'none';
                resultPlaceholder.style.display = 'block';
                generateButton.disabled = false;
            }
        };
        
        const setModal = (modalData) => {
            modal = modalData;
            const modalElement = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            
            if (modalData.visible) {
                modalTitle.textContent = modalData.title;
                if (modalData.type === 'image') {
                    modalContent.innerHTML = `<img src="${modalData.content}" style="max-width: 100%; height: auto; border-radius: 12px;" />`;
                } else {
                    modalContent.innerHTML = modalData.content.replace(/\n/g, '<br>');
                }
                modalElement.style.display = 'block';
            } else {
                modalElement.style.display = 'none';
            }
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∞–π–ª–æ–≤
        const handleFileSelect = async (file, photoType) => {
            const preview = URL.createObjectURL(file);
            try {
                const base64 = await fileToBase64(file);
                const setter = photoType === 'client' ? setClientPhoto : setStylePhoto;
                setter({ file, preview, base64 });
            } catch (error) {
                console.error("Error converting file to base64", error);
                showErrorModal('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª.');
            }
        };
        
        const setClientPhoto = (photo) => {
            clientPhoto = photo;
            const preview = document.getElementById('client-photo-preview');
            const img = document.getElementById('client-preview-img');
            if (photo.preview) {
                img.src = photo.preview;
                preview.style.display = 'block';
            }
        };
        
        const setStylePhoto = (photo) => {
            stylePhoto = photo;
            const preview = document.getElementById('style-photo-preview');
            const img = document.getElementById('style-preview-img');
            if (photo.preview) {
                img.src = photo.preview;
                preview.style.display = 'block';
            }
        };
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–≤ —Ñ–∞–π–ª–æ–≤
        const setupFileUploaders = () => {
            const clientUploader = document.getElementById('client-photo-uploader');
            const styleUploader = document.getElementById('style-photo-uploader');
            
            [clientUploader, styleUploader].forEach((uploader, index) => {
                const photoType = index === 0 ? 'client' : 'style';
                
                uploader.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        if (e.target.files[0]) {
                            handleFileSelect(e.target.files[0], photoType);
                        }
                    };
                    input.click();
                });
                
                uploader.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                uploader.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (e.dataTransfer.files[0]) {
                        handleFileSelect(e.dataTransfer.files[0], photoType);
                    }
                });
            });
        };
        
        // API –∑–∞–ø—Ä–æ—Å—ã
        const generateImage = async ({ clientPhotoBase64, stylePhotoBase64, prompt }) => {
            const response = await fetch(`${proxyUrl}/api/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    clientPhotoBase64,
                    stylePhotoBase64,
                    prompt
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
            
            return data.base64Image;
        };
        
        const analyzeImageForText = async ({ systemPrompt, userPrompt, imageBase64 }) => {
            const response = await fetch(`${proxyUrl}/api/analyze`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    systemPrompt,
                    userPrompt,
                    imageBase64
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
            
            return data.text;
        };
        
        // –ö–ê–†–î–ò–ù–ê–õ–¨–ù–û –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–•
        const handleGenerate = async () => {
            if (!clientPhoto.base64) {
                showErrorModal("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ.");
                return;
            }
            
            if (!isPro && generationCount >= maxGenerations) {
                showErrorModal(`–í—ã –∏—Å—á–µ—Ä–ø–∞–ª–∏ –ª–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π (${maxGenerations}). –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.`);
                return;
            }
            
            const prompt = document.getElementById('prompt-input').value;
            if (!prompt && !stylePhoto.base64) {
                showErrorModal("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é –ø—Ä–∏—á–µ—Å–∫—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ-–ø—Ä–∏–º–µ—Ä.");
                return;
            }
            
            setLoading(true);
            
            let userPrompt = prompt || "professional hairstyle transformation";
            
            if (stylePhoto.base64) {
                // –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ñ–ï–°–¢–ö–ò–ô –ü–†–û–ú–ü–¢ –î–õ–Ø –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø –ü–†–ò–ß–ï–°–û–ö –ù–ê –ú–û–ë–ò–õ–¨–ù–´–•
                userPrompt = `MOBILE OPTIMIZED REFERENCE HAIRSTYLE CLONING PROTOCOL:

MISSION: Clone the reference hairstyle onto client's head with ABSOLUTE precision

STEP 1 - FACIAL IDENTITY LOCK:
- Client's face shape, features, expression = COMPLETELY FROZEN
- Skin tone, eye color, facial proportions = UNCHANGED
- Bone structure, asymmetries = PRESERVED EXACTLY

STEP 2 - REFERENCE ANALYSIS:
- Measure reference hair length against face proportions
- Identify exact cut technique and layering pattern
- Extract precise color formula and highlight placement
- Analyze texture pattern and curl definition
- Map styling direction and volume distribution

STEP 3 - SURGICAL HAIR TRANSPLANT:
- Remove client's original hair 100% completely
- Install reference hairstyle with millimeter precision
- Match every layer, every color gradient, every texture detail
- Align parting and asymmetry exactly as in reference
- Integrate seamlessly at natural hairline

MOBILE PROCESSING ENHANCEMENT:
- Apply maximum precision algorithms for small screen accuracy
- Use enhanced detail preservation for mobile rendering quality
- Ensure professional salon result despite mobile platform limitations

CLIENT SPECIFICATION: ${userPrompt}

EXECUTE PRECISE HAIRSTYLE CLONING WITH ZERO FACIAL CHANGES.`;
            } else {
                // –ë–ï–ó –§–û–¢–û-–ü–†–ò–ú–ï–†–ê - –°–£–ü–ï–†-–ó–ê–©–ò–¢–ê –õ–ò–¶–ê –ù–ê –ú–û–ë–ò–õ–¨–ù–´–•
                userPrompt = `MOBILE OPTIMIZED CUSTOM HAIRSTYLE CREATION:

MISSION: Create custom hairstyle while maintaining client's identity with surgical precision

FACIAL PRESERVATION PROTOCOL:
- LOCK client's face shape, features, bone structure completely
- FREEZE skin tone, eye color, facial proportions exactly
- MAINTAIN expression, lighting, photo quality identically
- PRESERVE all facial asymmetries and unique characteristics

HAIRSTYLE CREATION TASK:
- Remove client's original hair completely and safely
- Generate new hairstyle based on: "${userPrompt}"
- Apply professional salon-quality styling and finishing
- Integrate naturally with client's facial structure
- Match original photo lighting on new hair perfectly

MOBILE QUALITY OPTIMIZATION:
- Enhanced precision for mobile device processing power
- Maximum detail attention for small screen viewing
- Professional output quality despite platform limitations
- Extra facial feature preservation safeguards

RESULT STANDARD: Photorealistic salon-quality hairstyle transformation with PERFECT identity preservation.

EXECUTE CUSTOM HAIRSTYLE CREATION WITH ZERO FACIAL ALTERATION.`;
            }
            
            const fullPrompt = `${GENERATION_SYSTEM_PROMPT}

${userPrompt}

MOBILE DEVICE QUALITY CONTROL CHECKLIST:
‚úì Client's facial identity 100% preserved?
‚úì Original hair completely removed/replaced?
‚úì New hairstyle applied with professional precision?
‚úì Reference style copied with photographic accuracy?
‚úì Natural hairline integration achieved?
‚úì Professional salon quality maintained?
‚úì Mobile screen optimization applied?

FINAL COMMAND: EXECUTE PERFECT HAIR TRANSFORMATION WITH IDENTITY PRESERVATION.`;
            
            try {
                const resultBase64 = await generateImage({
                    clientPhotoBase64: clientPhoto.base64,
                    stylePhotoBase64: stylePhoto.base64,
                    prompt: fullPrompt,
                });
                
                const watermarkedDataUrl = `data:image/png;base64,${resultBase64}`;
                generatedImage.preview = watermarkedDataUrl;
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const resultContainer = document.getElementById('result-container');
                const resultPlaceholder = document.getElementById('result-placeholder');
                const resultImage = document.getElementById('result-image');
                
                resultImage.src = watermarkedDataUrl;
                resultContainer.style.display = 'block';
                resultPlaceholder.style.display = 'none';
                
                if (!isPro) {
                    generationCount++;
                    localStorage.setItem('generationCount_v2', generationCount.toString());
                }
                
                console.log('‚úÖ –ú–æ–±–∏–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                updateUI();
                
            } catch (error) {
                console.error("‚ùå Mobile generation error:", error);
                showErrorModal(error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            } finally {
                setLoading(false);
            }
        };
        
        const handleLLMCall = async (systemPrompt, userPrompt, imageBase64) => {
            if (!imageBase64) {
                showErrorModal('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ.');
                return null;
            }
            
            setLoading(true);
            
            try {
                const result = await analyzeImageForText({ systemPrompt, userPrompt, imageBase64 });
                return result;
            } catch (error) {
                console.error("LLM call error:", error);
                showErrorModal(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI.');
                return null;
            } finally {
                setLoading(false);
            }
        };
        
        const getHairstyleSuggestions = async () => {
            const result = await handleLLMCall(
                SUGGESTION_SYSTEM_PROMPT, 
                "Recommend 3-4 flattering hairstyles for this person's face shape.", 
                clientPhoto.base64
            );
            if (result) {
                setModal({ visible: true, title: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏—á–µ—Å–∫–∞–º', content: result, type: 'text' });
            }
        };
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ü–ò–°–ê–ù–ò–Ø (–¢–û–õ–¨–ö–û –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï)
        const describeHairstyle = async () => {
            const result = await handleLLMCall(
                DESCRIBE_SYSTEM_PROMPT, 
                "Provide technical description of this hairstyle for AI generation", 
                stylePhoto.base64
            );
            if (result) {
                // –°–£–ü–ï–†-–û–ß–ò–°–¢–ö–ê –û–¢ –í–°–ï–ì–û –õ–ò–®–ù–ï–ì–û
                const cleanResult = result
                    .replace(/\*+/g, '') // —É–±–∏—Ä–∞–µ–º –∑–≤–µ–∑–¥–æ—á–∫–∏
                    .replace(/–û—Ç–ª–∏—á–Ω–æ.*?–ø–æ–≤—Ç–æ—Ä–∏—Ç—å\.?/gi, '')
                    .replace(/–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.*?:/gi, '')
                    .replace(/–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º.*?:/gi, '')
                    .replace(/–ê–Ω–∞–ª–∏–∑.*?:/gi, '')
                    .replace(/–û–ø–∏—Å–∞–Ω–∏–µ.*?:/gi, '')
                    .replace(/^\s*[-‚Ä¢*‚Ññ]\s*/gm, '') // —É–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã
                    .replace(/\n+/g, ' ') // —Å–∫–ª–µ–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏
                    .replace(/\s+/g, ' ') // —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                    .trim();
                
                document.getElementById('prompt-input').value = cleanResult;
            }
        };
        
        const applyPromoCode = () => {
            const code = document.getElementById('promo-input').value.trim().toUpperCase();
            if (code === CORRECT_PROMO_CODE) {
                isPro = true;
                localStorage.setItem('isPro_v2', 'true');
                setModal({ visible: true, title: '–£—Å–ø–µ—Ö!', content: '–ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è PRO-–¥–æ—Å—Ç—É–ø–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω! –í—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–Ω—è—Ç—ã.', type: 'text' });
            } else if (code === TEST_PROMO_CODE) {
                maxGenerations += 30;
                localStorage.setItem('maxGenerations_v2', maxGenerations.toString());
                setModal({ visible: true, title: '–£—Å–ø–µ—Ö!', content: '–í–∞–º –¥–æ–±–∞–≤–ª–µ–Ω–æ 30 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π!', type: 'text' });
            } else {
                setModal({ visible: true, title: '–û—à–∏–±–∫–∞', content: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥.', type: 'text' });
            }
            document.getElementById('promo-input').value = '';
            updateUI();
        };
        
        const buyGenerations = () => {
            window.open('https://t.me/tatianasotina', '_blank');
        };
        
        // –§–£–ù–ö–¶–ò–ò –ü–û–î–ï–õ–ò–¢–¨–°–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –°–°–´–õ–ö–ò)
        const shareToVK = () => {
            if (!generatedImage.preview) {
                showErrorModal('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
                return;
            }
            
            const text = `–ü–æ–ø—Ä–æ–±–æ–≤–∞–ª–∞ –Ω–æ–≤—É—é –ø—Ä–∏—á–µ—Å–∫—É –≤ —Å–∞–ª–æ–Ω–µ MISS SLIVKI! üíá‚Äç‚ôÄÔ∏è 
–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø—Ä–∏–º–µ—Ä–∫–∞ - —ç—Ç–æ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —É–¥–æ–±–Ω–æ! 
–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∞–º–∏: @NewStyleSalon_Bot
#–Ω–æ–≤—ã–π–æ–±—Ä–∞–∑ #missslivki #–≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è–ø—Ä–∏–º–µ—Ä–∫–∞`;
            
            const vkUrl = `https://vk.com/share.php?url=${encodeURIComponent('https://t.me/NewStyleSalon_Bot')}&title=${encodeURIComponent(text)}`;
            window.open(vkUrl, '_blank');
        };
        
        const shareToTelegram = () => {
            if (!generatedImage.preview) {
                showErrorModal('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
                return;
            }
            
            const text = `üé® –ü–æ–ø—Ä–æ–±–æ–≤–∞–ª–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø—Ä–∏–º–µ—Ä–∫—É –ø—Ä–∏—á–µ—Å–æ–∫ –≤ —Å–∞–ª–æ–Ω–µ MISS SLIVKI!
            
–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ—Å—Ç–æ –æ–≥–æ–Ω—å! üî•
            
–ö—Ç–æ —Ö–æ—á–µ—Ç —Ç–æ–∂–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ –±–µ–∑ —Ä–∏—Å–∫–∞ - –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ: @NewStyleSalon_Bot
            
–ü–µ—Ä–≤—ã–µ 10 –ø—Ä–∏–º–µ—Ä–æ–∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ! ‚ú®`;
            
            const tgUrl = `https://t.me/share/url?url=${encodeURIComponent('https://t.me/NewStyleSalon_Bot')}&text=${encodeURIComponent(text)}`;
            window.open(tgUrl, '_blank');
        };
        
        const downloadResult = () => {
            if (!generatedImage.preview) {
                showErrorModal('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
                return;
            }
            
            const link = document.createElement('a');
            link.download = 'miss_slivki_new_style.png';
            link.href = generatedImage.preview;
            link.click();
        };
        
        const resetAll = () => {
            clientPhoto = { file: null, preview: null, base64: null };
            stylePhoto = { file: null, preview: null, base64: null };
            generatedImage = { preview: null };
            
            document.getElementById('client-photo-preview').style.display = 'none';
            document.getElementById('style-photo-preview').style.display = 'none';
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('result-placeholder').style.display = 'block';
            document.getElementById('prompt-input').value = '';
            
            updateUI();
        };
        
        const updateUI = () => {
            const remainingCount = document.getElementById('remaining-count');
            const maxCount = document.getElementById('max-count');
            
            remainingCount.textContent = Math.max(0, maxGenerations - generationCount);
            maxCount.textContent = maxGenerations;
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            setupFileUploaders();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('generate-button').addEventListener('click', handleGenerate);
            document.getElementById('suggest-hairstyles').addEventListener('click', getHairstyleSuggestions);
            document.getElementById('describe-hairstyle').addEventListener('click', describeHairstyle);
            document.getElementById('apply-promo').addEventListener('click', applyPromoCode);
            document.getElementById('buy-generations').addEventListener('click', buyGenerations);
            document.getElementById('reset-all').addEventListener('click', resetAll);
            document.getElementById('close-modal').addEventListener('click', () => setModal({ visible: false }));
            
            // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö –ü–û–î–ï–õ–ò–¢–¨–°–Ø
            document.getElementById('share-vk').addEventListener('click', shareToVK);
            document.getElementById('share-telegram').addEventListener('click', shareToTelegram);
            document.getElementById('download-result').addEventListener('click', downloadResult);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ—ë
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target.id === 'modal') {
                    setModal({ visible: false });
                }
            });
            
            updateUI();
            console.log('üéØ MISS SLIVKI AI –∑–∞–≥—Ä—É–∂–µ–Ω —Å –º–æ–±–∏–ª—å–Ω—ã–º–∏ —Ñ–∏–∫—Å–∞–º–∏!');
        });
    </script>
</body>
</html>
